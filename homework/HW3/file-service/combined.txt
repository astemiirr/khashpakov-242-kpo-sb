=== ./gateway/src/main/java/gateway/Application.java ===
package gateway;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
=== ./gateway/src/main/java/gateway/web/ProxyController.java ===
package gateway.web;

import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.AllArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

@RestController
@AllArgsConstructor
@Tag(name = "Gateway", description = "Сборник всех API")
public class ProxyController {
    private RestTemplate restTemplate;

    @GetMapping("/v3/api-docs/storage")
    public ResponseEntity<String> proxyServiceA() {
        String url = "http://storage:8081/v3/api-docs";
        return restTemplate.getForEntity(url, String.class);
    }

    @GetMapping("/v3/api-docs/analysis")
    public ResponseEntity<String> proxyServiceB() {
        String url = "http://analysis:8082/v3/api-docs";
        return restTemplate.getForEntity(url, String.class);
    }
}=== ./gateway/src/main/java/gateway/web/config/swagger/CorsConfig.java ===
package gateway.web.config.swagger;

import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class CorsConfig implements WebMvcConfigurer {
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**").allowedOrigins("*").allowedMethods("GET", "POST", "PUT", "DELETE");
    }
}=== ./gateway/src/main/java/gateway/web/config/swagger/SwaggerConfig.java ===
package gateway.web.config.swagger;

import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.info.Info;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class SwaggerConfig {
    @Bean
    public OpenAPI customOpenAPI() {
        return new OpenAPI().info(new Info().title("Gateway API")
                                            .version("1.0")
                                            .description("API для сбора других API"));
    }
}=== ./gateway/src/main/java/gateway/web/RestConfig.java ===
package gateway.web;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.client.RestTemplate;

@Configuration
public class RestConfig {
    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}=== ./storage/src/test/java/storage/FileServiceTest.java ===
package storage;

import static org.junit.jupiter.api.Assertions.assertAll;
import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.mockito.ArgumentMatchers.any;

import com.fasterxml.jackson.databind.ObjectMapper;
import java.io.IOException;
import java.nio.file.Path;
import java.util.Optional;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.mockito.Mockito;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.MediaType;
import org.springframework.mock.web.MockMultipartFile;
import org.springframework.test.annotation.DirtiesContext;
import org.springframework.test.context.bean.override.mockito.MockitoSpyBean;
import org.springframework.web.multipart.MultipartFile;
import storage.domains.FileEntity;
import storage.repositories.FileRepository;
import storage.services.FileService;

@SpringBootTest
@DirtiesContext(classMode = DirtiesContext.ClassMode.BEFORE_EACH_TEST_METHOD)
class FileServiceTest {
    ObjectMapper objectMapper = new ObjectMapper();

    @MockitoSpyBean
    FileRepository fileRepository;

    @MockitoSpyBean
    private FileService fileService;

    @Test
    @DisplayName("Успешное сохранение тестового файла")
    void saveFile_Success() throws Exception {
        var mockFile = new MockMultipartFile("file", "test.txt", MediaType.TEXT_PLAIN_VALUE, "TEst text".getBytes());


        Mockito.doNothing().when(fileService).save(any(Path.class), any(MultipartFile.class));

        var fileEntity = fileService.saveFile(mockFile);

        assertAll(
                () -> assertNotNull(fileEntity.getId()),
                () -> assertEquals(fileEntity.getHash(), fileService.getFileHash(fileEntity.getId())),
                () -> assertEquals(fileEntity.getName(), mockFile.getOriginalFilename()),
                () -> assertTrue(fileEntity.getPath().startsWith("location/content"))
        );
    }

    @Test
    @DisplayName("Исключение при сохранении тестового файла")
    void saveFile_Failure() throws Exception {
        var mockFile = new MockMultipartFile("file", "test.txt", MediaType.TEXT_PLAIN_VALUE, "TEst text".getBytes());

        Mockito.doThrow(new IOException()).when(fileService).save(any(Path.class), any(MultipartFile.class));

        var oldFilesCount = fileRepository.findAll().size();

        Assertions.assertThrows(IOException.class, () -> {fileService.saveFile(mockFile);});

        assertEquals(oldFilesCount, fileRepository.findAll().size());
    }

    @Test
    @DisplayName("Исключение при сохранении тестового файла")
    void loadFile_Success() throws Exception {
        var testEntity = FileEntity.builder().path("src/test/resources/data/testdata.txt").build();

        Mockito.when(fileRepository.getFileById(any(Integer.class))).thenReturn(Optional.of(testEntity));

        var data = fileService.getContentById(0);

        assertEquals("Example  data", data);
    }
}=== ./storage/src/test/java/storage/FileControllerTest.java ===
package storage;

import static org.junit.jupiter.api.Assertions.assertAll;
import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.doReturn;
import static org.mockito.Mockito.when;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.multipart;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

import com.fasterxml.jackson.databind.ObjectMapper;
import java.util.List;
import java.util.Optional;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.MediaType;
import org.springframework.mock.web.MockMultipartFile;
import org.springframework.test.annotation.DirtiesContext;
import org.springframework.test.context.bean.override.mockito.MockitoSpyBean;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.web.multipart.MultipartFile;
import storage.domains.FileEntity;
import storage.repositories.FileRepository;
import storage.services.FileService;
import storage.web.dtos.FileResponse;

@SpringBootTest
@AutoConfigureMockMvc
@DirtiesContext(classMode = DirtiesContext.ClassMode.BEFORE_EACH_TEST_METHOD)
class FileControllerTest {
    ObjectMapper objectMapper = new ObjectMapper();

    @Autowired
    private MockMvc mockMvc;

    @MockitoSpyBean
    private FileService fileService;

    @MockitoSpyBean
    private FileRepository fileRepository;

    @Test
    @DisplayName("Успешное добавление тестового файла")
    void uploadFile_Success() throws Exception {
        var mockFile = new MockMultipartFile("file", "test.txt", MediaType.TEXT_PLAIN_VALUE, "TEst text".getBytes());

        var mockFileEntity = FileEntity.builder()
                                       .id(1)
                                       .name("test.txt")
                                       .path("/location/content/test.txt")
                                       .hash("qwertyuiop")
                                       .build();

        doReturn(mockFileEntity).when(fileService).saveFile(any(MultipartFile.class));

        var response = mockMvc.perform(multipart("/api/files/upload").file(mockFile))
                              .andExpect(status().isOk())
                              .andReturn()
                              .getResponse()
                              .getContentAsString();
        var fileResponse = objectMapper.readValue(response, FileResponse.class);
        assertAll(
                () -> assertEquals(fileResponse.hash(), mockFileEntity.getHash()),
                () -> assertEquals(fileResponse.id(), mockFileEntity.getId()),
                () -> assertEquals(fileResponse.name(), mockFileEntity.getName()),
                () -> assertEquals(fileResponse.path(), mockFileEntity.getPath())
        );
    }

    @Test
    @DisplayName("Успешное получение содержания файла")
    void getContent_Success() throws Exception {
        var mockFileEntity = FileEntity.builder().path("src/test/resources/data/testdata.txt").build();

        when(fileRepository.getFileById(any(Integer.class))).thenReturn(Optional.of(mockFileEntity));

        var response = mockMvc.perform(get("/api/files/0/content"))
                              .andExpect(status().isOk())
                              .andReturn()
                              .getResponse()
                              .getContentAsString();
        assertEquals("Example  data", response);
    }

    @Test
    @DisplayName("Успешное получение одинаковых файлов")
    void getSameCount_Success() throws Exception {
        doReturn(Optional.of(FileEntity.builder().hash("abc").build())).when(fileRepository)
                                                                       .getFileById(any(Integer.class));
        doReturn(List.of()).when(fileRepository).findAllByHash(any(String.class));

        var response = mockMvc.perform(get("/api/files/0/same"))
                              .andExpect(status().isOk())
                              .andReturn()
                              .getResponse()
                              .getContentAsString();
        var resp = objectMapper.readValue(response, Integer.class);
        assertEquals(0, resp);
    }
}=== ./storage/src/main/java/storage/Application.java ===
package storage;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
=== ./storage/src/main/java/storage/repositories/FileRepository.java ===
package storage.repositories;

import java.util.List;
import java.util.Optional;
import org.springframework.data.jpa.repository.JpaRepository;
import storage.domains.FileEntity;

public interface FileRepository extends JpaRepository<FileEntity, Integer> {
    Optional<FileEntity> getFileById(Integer id);
    
    List<FileEntity> findAllByHash(String hash);
}=== ./storage/src/main/java/storage/web/controllers/FileController.java ===
package storage.web.controllers;


import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import java.io.IOException;
import lombok.AllArgsConstructor;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestPart;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;
import storage.domains.FileEntity;
import storage.repositories.FileRepository;
import storage.services.FileService;
import storage.web.dtos.FileResponse;

@AllArgsConstructor
@RestController
@RequestMapping("/api/files")
@Tag(name = "Микросервис хранения файлов", description = "Хранение данных")
public class FileController {
    private final FileRepository fileRepository;

    private FileService fileService;

    @PostMapping(value = "upload", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    @Operation(summary = "Загрузить файл")
    public ResponseEntity<FileResponse> uploadFile(@RequestPart("file") MultipartFile file) {
        try {
            var fileEntity = fileService.saveFile(file);
            var dto = fileToDto(fileEntity);
            return ResponseEntity.ok().body(dto);
        } catch (IOException e) {
            // Скорее всего битый файл
            return ResponseEntity.badRequest().build();
        }
    }

    @GetMapping("{id}")
    @Operation(summary = "Получить информацию о файле")
    public ResponseEntity<FileResponse> getFile(@PathVariable Integer id) {
        var fileOptional = fileService.getFileById(id);
        return fileOptional.map(fileEntity -> ResponseEntity.ok().body(fileToDto(fileEntity)))
                           .orElseGet(() -> ResponseEntity.notFound().build());
    }

    @GetMapping("{id}/same")
    @Operation(summary = "Получить число файлов с таким же содержимым")
    public ResponseEntity<Integer> getSameCount(@PathVariable Integer id) {
        var fileOptional = fileService.getFileById(id);
        if (fileOptional.isEmpty()) {
            return ResponseEntity.notFound().build();
        }
        var hash = fileOptional.get().getHash();
        return ResponseEntity.ok(fileRepository.findAllByHash(hash).size());
    }

    @GetMapping("{id}/content")
    @Operation(summary = "Получить содержимое файла")
    public ResponseEntity<String> getFileContent(@PathVariable Integer id) {
        try {
            return ResponseEntity.ok().body(fileService.getContentById(id));
        } catch (IOException e) {
            return ResponseEntity.notFound().build();
        }
    }

    private FileResponse fileToDto(FileEntity fileEntity) {
        return new FileResponse(fileEntity.getId(), fileEntity.getName(), fileEntity.getPath(), fileEntity.getHash());
    }
}=== ./storage/src/main/java/storage/web/dtos/FileResponse.java ===
package storage.web.dtos;

import lombok.Builder;

@Builder
public record FileResponse(
        Integer id,

        String name,

        String path,

        String hash
) {}=== ./storage/src/main/java/storage/web/config/swagger/CorsConfig.java ===
package storage.web.config.swagger;

import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class CorsConfig implements WebMvcConfigurer {
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**").allowedOrigins("*").allowedMethods("GET", "POST", "PUT", "DELETE");
    }
}=== ./storage/src/main/java/storage/web/config/swagger/SwaggerConfig.java ===
package storage.web.config.swagger;

import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.info.Info;
import io.swagger.v3.oas.models.servers.Server;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class SwaggerConfig {
    @Bean
    public OpenAPI customOpenAPI() {
        return new OpenAPI().info(new Info().title("File storage API")
                                            .version("1.0")
                                            .description("API для хранения файлов"))
                            .addServersItem(new Server().url("http://localhost:8081")
                                                        .description("Gateway URL"));
    }
}=== ./storage/src/main/java/storage/services/FileService.java ===
package storage.services;

import java.io.IOException;
import java.math.BigInteger;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.Optional;
import java.util.UUID;
import lombok.RequiredArgsConstructor;
import org.aspectj.util.FileUtil;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;
import storage.domains.FileEntity;
import storage.repositories.FileRepository;

@Service
@RequiredArgsConstructor
public class FileService {
    private final FileRepository fileRepository;

    @Value("${spring.servlet.multipart.location}")
    private String uploadDirectory;

    public void save(Path path, MultipartFile file) throws IOException {
        Files.createDirectories(path.getParent());
        Files.write(path, file.getBytes());
    }

    public FileEntity saveFile(MultipartFile file) throws IOException {
        String originalFilename = file.getOriginalFilename();
        String filename = UUID.randomUUID() + "_" + originalFilename;

        String shortPath = uploadDirectory + "/" + filename;

        Path path = Paths.get(shortPath);
        save(path, file);

        var hash = calculateFileHash(file.getBytes());

        FileEntity entity = new FileEntity();
        entity.setName(originalFilename);
        entity.setPath(shortPath);
        entity.setHash(hash);
        entity = fileRepository.save(entity);

        return entity;
    }

    public String getFileHash(Integer fileId) {
        var entity = fileRepository.getFileById(fileId);
        if (entity.isEmpty()) {
            throw new RuntimeException("File not found");
        }
        return entity.get().getHash();
    }

    public String getContentById(Integer fileId) throws IOException {
        var entity = fileRepository.getFileById(fileId);
        if (entity.isEmpty()) {
            throw new IOException("File not found");
        }
        var path = Paths.get(entity.get().getPath());
        return FileUtil.readAsString(path.toFile());
    }

    public Optional<FileEntity> getFileById(Integer fileId) {
        return fileRepository.getFileById(fileId);
    }

    private String calculateFileHash(byte[] content) {
        try {
            MessageDigest digest = MessageDigest.getInstance("SHA-256");
            byte[] hashBytes = digest.digest(content);
            return String.format("%064x", new BigInteger(1, hashBytes));
        } catch (NoSuchAlgorithmException e) {
            // В теории недостижимо
            return null;
        }
    }
}=== ./storage/src/main/java/storage/domains/FileEntity.java ===
package storage.domains;

import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import jakarta.validation.constraints.NotNull;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

@Getter
@Setter
@Builder
@Entity
@Table(name = "files")
@NoArgsConstructor
@AllArgsConstructor
public class FileEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer id;

    @NotNull
    private String name;

    @NotNull
    private String path;

    @NotNull
    private String hash;
}=== ./analysis/src/test/java/analysis/AnalysisServiceTest.java ===
package analysis;

import static org.junit.jupiter.api.Assertions.assertAll;
import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.doReturn;
import static org.mockito.Mockito.when;

import analysis.repositories.StatisticRepository;
import analysis.services.AnalysisService;
import analysis.services.FileService;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.util.Optional;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mockito;
import org.mockito.MockitoAnnotations;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.HttpStatusCode;
import org.springframework.http.ResponseEntity;
import org.springframework.test.context.bean.override.mockito.MockitoBean;
import org.springframework.web.client.RestTemplate;

@SpringBootTest
class AnalysisServiceTest {
    @MockitoBean
    private RestTemplate restTemplate;

    @MockitoBean
    private StatisticRepository statisticRepository;

    @Autowired
    @InjectMocks
    private FileService fileService;

    @Autowired
    @InjectMocks
    private AnalysisService analysisService;

    @BeforeEach
    public void openMocks() {
        MockitoAnnotations.openMocks(this);
    }

    @Test
    void generateWordCloud_Success() {
        byte[] mockImage = new byte[]{0x1, 0x2, 0x3, 0x4, 0x5};
        doReturn("Test text").when(restTemplate).getForObject(any(String.class), Mockito.any());
        var url = String.format(
                "https://quickchart.io/wordcloud?text=%s&format=png&width=800&height=600",
                URLEncoder.encode("Test text", StandardCharsets.UTF_8)
        );

        doReturn(new ResponseEntity<byte[]>(mockImage, HttpStatusCode.valueOf(200)))
                .when(restTemplate)
                .getForEntity(eq(url), Mockito.any());

        byte[] result = analysisService.generateWordCloud(1);

        Assertions.assertArrayEquals(mockImage, result);
    }

    @Test
    void analyzeFile_Success() {
        when(statisticRepository.getByFileId(any(Integer.class))).thenReturn(Optional.empty());
        when(statisticRepository.save(any())).thenAnswer(i -> i.getArgument(0));
        String text = "Test text\n\nPar2\n    \nPar 3";
        doReturn(text).when(restTemplate).getForObject(any(String.class), Mockito.any());

        var result = analysisService.analyze(0);

        assertAll(
                () -> assertEquals(3, result.getParagraphs()),
                () -> assertEquals(5, result.getWords()),
                () -> assertEquals(26, result.getSymbols())
        );
    }
}=== ./analysis/src/test/java/analysis/AnalysisControllerTest.java ===
package analysis;

import static org.junit.jupiter.api.Assertions.assertAll;
import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.doAnswer;
import static org.mockito.Mockito.doReturn;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

import analysis.repositories.StatisticRepository;
import analysis.services.AnalysisService;
import analysis.services.FileService;
import analysis.web.dtos.StatisticResponse;
import com.fasterxml.jackson.databind.ObjectMapper;
import java.util.Optional;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.annotation.DirtiesContext;
import org.springframework.test.context.bean.override.mockito.MockitoSpyBean;
import org.springframework.test.web.servlet.MockMvc;

@SpringBootTest
@AutoConfigureMockMvc
@DirtiesContext(classMode = DirtiesContext.ClassMode.BEFORE_EACH_TEST_METHOD)
class AnalysisControllerTest {
    ObjectMapper objectMapper = new ObjectMapper();

    @Autowired
    private MockMvc mockMvc;

    @MockitoSpyBean
    private FileService fileService;

    @MockitoSpyBean
    private StatisticRepository statisticRepository;

    @MockitoSpyBean
    private AnalysisService analysisService;

    @Test
    @DisplayName("Успешное получение статистики")
    void getStat_Success() throws Exception {
        var content = "a b \n\n C";

        doReturn(content).when(fileService).getFileContent(any(Integer.class));
        doReturn(Optional.empty()).when(statisticRepository).getByFileId(any(Integer.class));
        doAnswer(i -> i.getArgument(0)).when(statisticRepository).save(any());

        var response = mockMvc.perform(get("/api/analysis/1"))
                              .andExpect(status().isOk())
                              .andReturn()
                              .getResponse()
                              .getContentAsString();
        var statResponse = objectMapper.readValue(response, StatisticResponse.class);
        assertAll(
                () -> assertEquals(1, statResponse.fileId()),
                () -> assertEquals(2, statResponse.paragraphs()),
                () -> assertEquals(3, statResponse.words()),
                () -> assertEquals(8, statResponse.symbols())
        );
    }

    @Test
    @DisplayName("Успешное проверка на плагиат")
    void checkPlagiarised_Success() throws Exception {
        doReturn(1).when(fileService).getSameCount(any(Integer.class));
        var response = mockMvc.perform(get("/api/analysis/1/plagiarised"))
                              .andExpect(status().isOk())
                              .andReturn()
                              .getResponse()
                              .getContentAsString();
        var resp = objectMapper.readValue(response, Boolean.class);
        assertEquals(false, resp);
    }
}=== ./analysis/src/main/java/analysis/Application.java ===
package analysis;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
=== ./analysis/src/main/java/analysis/repositories/StatisticRepository.java ===
package analysis.repositories;

import analysis.domains.StatisticEntity;
import java.util.Optional;
import org.springframework.data.jpa.repository.JpaRepository;

public interface StatisticRepository extends JpaRepository<StatisticEntity, Integer> {
    Optional<StatisticEntity> getByFileId(Integer fileId);
}=== ./analysis/src/main/java/analysis/web/controllers/AnalysisController.java ===
package analysis.web.controllers;

import analysis.domains.StatisticEntity;
import analysis.services.AnalysisService;
import analysis.web.dtos.StatisticResponse;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.AllArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@Slf4j
@RestController
@AllArgsConstructor
@Tag(name = "Микросервис анализа файлов", description = "Анализ данных")
@RequestMapping("/api/analysis")
public class AnalysisController {
    private AnalysisService analysisService;

    @GetMapping("{fileId}")
    @Operation(summary = "Получить статистику файла")
    public ResponseEntity<StatisticResponse> analyze(@PathVariable Integer fileId) {
        try {
            var result = analysisService.analyze(fileId);
            return ResponseEntity.ok(statisticToDto(result));
        } catch (Exception e) {
            return ResponseEntity.notFound().build();
        }
    }

    @GetMapping(value = "/{fileId}/wordcloud", produces = MediaType.IMAGE_PNG_VALUE)
    @Operation(summary = "Визуализировать облако слов")
    public ResponseEntity<byte[]> generateWordCloud(@PathVariable Integer fileId) {
        try {
            byte[] image = analysisService.generateWordCloud(fileId);
            return ResponseEntity.ok().contentType(MediaType.IMAGE_PNG).body(image);
        } catch (Exception e) {
            return ResponseEntity.badRequest().build();
        }
    }

    @GetMapping("/{fileId}/plagiarised")
    @Operation(summary = "Проверить файл на существование идентичного")
    public ResponseEntity<Boolean> checkPlagiarised(@PathVariable Integer fileId) {
        try {
            return ResponseEntity.ok(analysisService.checkPlagiarise(fileId));
        } catch (Exception e) {
            return ResponseEntity.badRequest().build();
        }
    }

    private StatisticResponse statisticToDto(StatisticEntity entity) {
        return new StatisticResponse(
                entity.getFileId(),
                entity.getParagraphs(),
                entity.getWords(),
                entity.getSymbols()
        );
    }
}=== ./analysis/src/main/java/analysis/web/dtos/StatisticResponse.java ===
package analysis.web.dtos;

public record StatisticResponse(
        Integer fileId,

        Integer paragraphs,

        Integer words,

        Integer symbols
) {}=== ./analysis/src/main/java/analysis/web/config/CorsConfig.java ===
package analysis.web.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class CorsConfig implements WebMvcConfigurer {
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**").allowedOrigins("*").allowedMethods("GET", "POST", "PUT", "DELETE");
    }
}=== ./analysis/src/main/java/analysis/web/config/swagger/SwaggerConfig.java ===
package analysis.web.config.swagger;

import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.info.Info;
import io.swagger.v3.oas.models.servers.Server;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class SwaggerConfig {
    @Bean
    public OpenAPI customOpenAPI() {
        return new OpenAPI().info(new Info().title("File analysis API")
                                            .version("1.0")
                                            .description("API для анализа файлов"))
                            .addServersItem(new Server().url("http://localhost:8082")
                                                        .description("Gateway URL"));
    }
}=== ./analysis/src/main/java/analysis/web/config/RestConfig.java ===
package analysis.web.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.client.RestTemplate;

@Configuration
public class RestConfig {
    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}=== ./analysis/src/main/java/analysis/services/FileService.java ===
package analysis.services;

import lombok.AllArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

@Service
@AllArgsConstructor
public class FileService {
    RestTemplate restTemplate;

    public String getFileContent(Integer fileId) {
        String url = "http://storage:8081/api/files/" + fileId + "/content";

        return restTemplate.getForObject(url, String.class);
    }

    public Integer getSameCount(Integer fileId) {
        String url = "http://storage:8081/api/files/" + fileId + "/same";

        return restTemplate.getForObject(url, Integer.class);
    }
}=== ./analysis/src/main/java/analysis/services/AnalysisService.java ===
package analysis.services;

import analysis.domains.StatisticEntity;
import analysis.repositories.StatisticRepository;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.util.Arrays;
import lombok.AllArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

@Service
@AllArgsConstructor
public class AnalysisService {
    private RestTemplate restTemplate;

    private FileService fileService;

    private StatisticRepository statisticRepository;

    public Boolean checkPlagiarise(Integer fileId) {
        return fileService.getSameCount(fileId) > 1;
    }

    public byte[] generateWordCloud(Integer fileId) {
        String content = fileService.getFileContent(fileId);

        String encodedText = URLEncoder.encode(content, StandardCharsets.UTF_8);
        String url = String.format(
                "https://quickchart.io/wordcloud?text=%s&format=png&width=800&height=600",
                encodedText
        );

        ResponseEntity<byte[]> response = restTemplate.getForEntity(url, byte[].class);
        return response.getBody();
    }

    public StatisticEntity analyze(Integer fileId) {
        var statisticOptional = statisticRepository.getByFileId(fileId);
        if (statisticOptional.isPresent()) {
            return statisticOptional.get();
        }

        String text = fileService.getFileContent(fileId);

        int paragraphs = countParagraphs(text);
        int words = countWords(text);
        int symbols = text.length();

        var result = new StatisticEntity();
        result.setFileId(fileId);
        result.setParagraphs(paragraphs);
        result.setWords(words);
        result.setSymbols(symbols);

        result = statisticRepository.save(result);
        return result;
    }

    private int countParagraphs(String text) {
        var pars = Arrays.asList(text.trim().split("\\n\\s*\\n"));
        pars.removeIf(String::isBlank);
        return pars.size();
    }

    private int countWords(String text) {
        return text.trim().split("\\s+").length;
    }
}=== ./analysis/src/main/java/analysis/domains/StatisticEntity.java ===
package analysis.domains;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.Table;
import jakarta.validation.constraints.NotNull;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "statistics")
public class StatisticEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer id;

    @Column(nullable = false, name = "file_id")
    private Integer fileId;

    @NotNull
    private Integer paragraphs;

    @NotNull
    private Integer words;

    @NotNull
    private Integer symbols;
}